#!/bin/bash
# DevSmith Pre-Push Validation Hook
# SELECTIVE MODE: Only validates files being pushed (HEAD~1..HEAD)
# This keeps local feedback fast while still catching NEW issues
# Do NOT bypass with --no-verify (use only when necessary for infrastructure changes)

set -euo pipefail

PROJECT_ROOT="$(git rev-parse --show-toplevel)"
cd "$PROJECT_ROOT"

echo "ğŸ” Running pre-push validation (SELECTIVE MODE - current commit only)..."
echo ""

FAILED=0

# Get list of modified .go files in THIS commit (HEAD) only
# This is defined early so all checks can use it
MODIFIED_FILES=$(git diff --name-only HEAD~1..HEAD 2>/dev/null | grep '\.go$' || true)
MODIFIED_GO_FILES="$MODIFIED_FILES"  # Alias for compatibility

if [ -z "$MODIFIED_FILES" ]; then
    echo "â„¹ï¸  No files modified in current commit. Skipping validation."
    exit 0
fi

echo "ğŸ“‹ Files being pushed:"
echo "$MODIFIED_FILES" | sed 's/^/   /'
echo ""

# 1. FORMAT CHECK (gofmt)
echo "1ï¸âƒ£  Checking formatting (gofmt)..."
if [ -n "$MODIFIED_GO_FILES" ]; then
    UNFORMATTED=$(gofmt -l $MODIFIED_GO_FILES 2>/dev/null || true)
    if [ -n "$UNFORMATTED" ]; then
        echo "âŒ FAILED: Files not formatted"
        echo "$UNFORMATTED" | sed 's/^/   /'
        FAILED=1
    else
        echo "âœ… PASSED: Modified files formatted"
    fi
else
    echo "â„¹ï¸  No Go files modified"
fi

# 2. IMPORTS CHECK (goimports) - MODIFIED FILES ONLY
echo "2ï¸âƒ£  Checking imports (goimports)..."
if [ -n "$MODIFIED_GO_FILES" ]; then
    UNIMPORTED=$(goimports -l $MODIFIED_GO_FILES 2>/dev/null || true)
    if [ -n "$UNIMPORTED" ]; then
        echo "âŒ FAILED: Imports not resolved"
        echo "$UNIMPORTED" | sed 's/^/   /'
        FAILED=1
    else
        echo "âœ… PASSED: Imports correct"
    fi
else
    echo "â„¹ï¸  No Go files modified"
fi

# 3. BUILD CHECK - MODIFIED PACKAGES ONLY
echo "3ï¸âƒ£  Checking build..."
if [ -n "$MODIFIED_GO_FILES" ]; then
    MODIFIED_PACKAGES=$(echo "$MODIFIED_GO_FILES" | sed 's|/[^/]*\.go$||' | sort -u | sed 's|^|./|')
    if ! go build $MODIFIED_PACKAGES 2>&1; then
        echo "âŒ FAILED: Modified packages don't compile"
        FAILED=1
    else
        echo "âœ… PASSED: Modified packages compile"
    fi
else
    echo "â„¹ï¸  No Go files modified"
fi

# 4. LINTING CHECK (golangci-lint) - MODIFIED FILES ONLY
echo "4ï¸âƒ£  Checking linting (golangci-lint)..."
if ! command -v golangci-lint &>/dev/null; then
    echo "âš ï¸  WARNING: golangci-lint not installed"
else
    if [ -z "$MODIFIED_GO_FILES" ]; then
        echo "â„¹ï¸  No Go files modified in this commit"
    else
        # Extract unique PACKAGES from modified files (not individual files)
        # This gives golangci-lint proper context for type checking
        MODIFIED_PACKAGES=$(echo "$MODIFIED_GO_FILES" | sed 's|/[^/]*\.go$||' | sort -u | sed 's|^|./|')
        
        echo "   Linting packages with modified files:"
        echo "$MODIFIED_PACKAGES" | sed 's/^/     /'
        echo ""
        
        # Run golangci-lint on packages (not individual files)
        # This prevents false "undefined" errors from missing import context
        # Use --fast to skip slow linters, --timeout to prevent hangs
        LINT_OUTPUT=$(golangci-lint run $MODIFIED_PACKAGES --fast --timeout=30s 2>&1 || true)
        
        # Filter output to only show errors from MODIFIED files
        # This prevents errors in other files in the same package from being reported
        FILTERED_OUTPUT=""
        for FILE in $MODIFIED_GO_FILES; do
            if echo "$LINT_OUTPUT" | grep -q "^$FILE:"; then
                FILTERED_OUTPUT=$(echo "$FILTERED_OUTPUT"; echo "$LINT_OUTPUT" | grep "^$FILE:")
            fi
        done
        
        if [ -n "$FILTERED_OUTPUT" ]; then
            echo "âŒ FAILED: Linting errors in modified files"
            echo "$FILTERED_OUTPUT" | head -20 | sed 's/^/   /'
            FAILED=1
        else
            echo "âœ… PASSED: Modified files lint clean"
        fi
    fi
fi

# 5. VET CHECK - MODIFIED PACKAGES ONLY
echo "5ï¸âƒ£  Checking vet (go vet)..."
if [ -n "$MODIFIED_GO_FILES" ]; then
    MODIFIED_PACKAGES=$(echo "$MODIFIED_GO_FILES" | sed 's|/[^/]*\.go$||' | sort -u | sed 's|^|./|')
    if ! go vet $MODIFIED_PACKAGES 2>&1; then
        echo "âŒ FAILED: Go vet found issues"
        FAILED=1
    else
        echo "âœ… PASSED: Go vet clean"
    fi
else
    echo "â„¹ï¸  No Go files modified"
fi

# 6. TEST CHECK - SHORT TESTS ONLY FOR MODIFIED PACKAGES
echo "6ï¸âƒ£  Running tests (short mode)..."
if [ -n "$MODIFIED_GO_FILES" ]; then
    MODIFIED_PACKAGES=$(echo "$MODIFIED_GO_FILES" | sed 's|/[^/]*\.go$||' | sort -u | sed 's|^|./|')
    echo "   Testing packages: $MODIFIED_PACKAGES"
    
    # Run tests with -short flag and 30s timeout
    # This skips slow integration tests and prevents hanging
    if ! go test -short -timeout=30s $MODIFIED_PACKAGES 2>&1; then
        echo "âŒ FAILED: Tests failed in modified packages"
        echo "   Run 'go test -v $MODIFIED_PACKAGES' for details"
        FAILED=1
    else
        echo "âœ… PASSED: Short tests pass in modified packages"
    fi
else
    echo "â„¹ï¸  No Go files modified"
fi

echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
echo "â­ï¸  Note: Full test suite and race detection run in CI/CD"
echo "   Pre-push runs short tests to catch obvious failures fast"
echo "   Typical duration: 10-20s for modified packages"
echo ""
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

if [[ $FAILED -eq 0 ]]; then
    echo "âœ… PRE-PUSH CHECKS PASSED"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    exit 0
else
    echo "âŒ PRE-PUSH CHECKS FAILED"
    echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
    echo ""
    echo "Quick fixes:"
    echo "  1. Run: gofmt -w <files>"
    echo "  2. Run: goimports -w <files>"
    echo "  3. Fix build/lint errors in your code"
    echo "  4. Try push again"
    exit 1
fi
