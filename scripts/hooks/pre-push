#!/bin/bash
# DevSmith Pre-Push Validation Hook
# SELECTIVE MODE: Only validates files being pushed (HEAD~1..HEAD)
# This keeps local feedback fast while still catching NEW issues
# Do NOT bypass with --no-verify (use only when necessary for infrastructure changes)

set -euo pipefail

PROJECT_ROOT="$(git rev-parse --show-toplevel)"
cd "$PROJECT_ROOT"

echo "🔍 Running pre-push validation (SELECTIVE MODE - current commit only)..."
echo ""

FAILED=0

# Get list of modified .go files in THIS commit (HEAD) only
# This is defined early so all checks can use it
MODIFIED_FILES=$(git diff --name-only HEAD~1..HEAD 2>/dev/null | grep '\.go$' || true)
MODIFIED_GO_FILES="$MODIFIED_FILES"  # Alias for compatibility

if [ -z "$MODIFIED_FILES" ]; then
    echo "ℹ️  No files modified in current commit. Skipping validation."
    exit 0
fi

echo "📋 Files being pushed:"
echo "$MODIFIED_FILES" | sed 's/^/   /'
echo ""

# 1. FORMAT CHECK (gofmt)
echo "1️⃣  Checking formatting (gofmt)..."
if [ -n "$MODIFIED_GO_FILES" ]; then
    UNFORMATTED=$(gofmt -l $MODIFIED_GO_FILES 2>/dev/null || true)
    if [ -n "$UNFORMATTED" ]; then
        echo "❌ FAILED: Files not formatted"
        echo "$UNFORMATTED" | sed 's/^/   /'
        FAILED=1
    else
        echo "✅ PASSED: Modified files formatted"
    fi
else
    echo "ℹ️  No Go files modified"
fi

# 2. IMPORTS CHECK (goimports) - MODIFIED FILES ONLY
echo "2️⃣  Checking imports (goimports)..."
if [ -n "$MODIFIED_GO_FILES" ]; then
    UNIMPORTED=$(goimports -l $MODIFIED_GO_FILES 2>/dev/null || true)
    if [ -n "$UNIMPORTED" ]; then
        echo "❌ FAILED: Imports not resolved"
        echo "$UNIMPORTED" | sed 's/^/   /'
        FAILED=1
    else
        echo "✅ PASSED: Imports correct"
    fi
else
    echo "ℹ️  No Go files modified"
fi

# 3. BUILD CHECK - MODIFIED PACKAGES ONLY
echo "3️⃣  Checking build..."
if [ -n "$MODIFIED_GO_FILES" ]; then
    MODIFIED_PACKAGES=$(echo "$MODIFIED_GO_FILES" | sed 's|/[^/]*\.go$||' | sort -u | sed 's|^|./|')
    if ! go build $MODIFIED_PACKAGES 2>&1; then
        echo "❌ FAILED: Modified packages don't compile"
        FAILED=1
    else
        echo "✅ PASSED: Modified packages compile"
    fi
else
    echo "ℹ️  No Go files modified"
fi

# 4. LINTING CHECK (golangci-lint) - MODIFIED FILES ONLY
echo "4️⃣  Checking linting (golangci-lint)..."
if ! command -v golangci-lint &>/dev/null; then
    echo "⚠️  WARNING: golangci-lint not installed"
else
    if [ -z "$MODIFIED_GO_FILES" ]; then
        echo "ℹ️  No Go files modified in this commit"
    else
        # Extract unique PACKAGES from modified files (not individual files)
        # This gives golangci-lint proper context for type checking
        MODIFIED_PACKAGES=$(echo "$MODIFIED_GO_FILES" | sed 's|/[^/]*\.go$||' | sort -u | sed 's|^|./|')
        
        echo "   Linting packages with modified files:"
        echo "$MODIFIED_PACKAGES" | sed 's/^/     /'
        echo ""
        
        # Run golangci-lint on packages (not individual files)
        # This prevents false "undefined" errors from missing import context
        # Use --fast to skip slow linters, --timeout to prevent hangs
        LINT_OUTPUT=$(golangci-lint run $MODIFIED_PACKAGES --fast --timeout=30s 2>&1 || true)
        
        # Filter output to only show errors from MODIFIED files
        # This prevents errors in other files in the same package from being reported
        FILTERED_OUTPUT=""
        for FILE in $MODIFIED_GO_FILES; do
            if echo "$LINT_OUTPUT" | grep -q "^$FILE:"; then
                FILTERED_OUTPUT=$(echo "$FILTERED_OUTPUT"; echo "$LINT_OUTPUT" | grep "^$FILE:")
            fi
        done
        
        if [ -n "$FILTERED_OUTPUT" ]; then
            echo "❌ FAILED: Linting errors in modified files"
            echo "$FILTERED_OUTPUT" | head -20 | sed 's/^/   /'
            FAILED=1
        else
            echo "✅ PASSED: Modified files lint clean"
        fi
    fi
fi

# 5. VET CHECK - MODIFIED PACKAGES ONLY
echo "5️⃣  Checking vet (go vet)..."
if [ -n "$MODIFIED_GO_FILES" ]; then
    MODIFIED_PACKAGES=$(echo "$MODIFIED_GO_FILES" | sed 's|/[^/]*\.go$||' | sort -u | sed 's|^|./|')
    if ! go vet $MODIFIED_PACKAGES 2>&1; then
        echo "❌ FAILED: Go vet found issues"
        FAILED=1
    else
        echo "✅ PASSED: Go vet clean"
    fi
else
    echo "ℹ️  No Go files modified"
fi

echo ""
echo "════════════════════════════════════════════════════════════"
echo ""
echo "⏭️  Note: Test execution and race detection run in CI/CD"
echo "   Pre-push keeps local feedback FAST (5-10s typical)"
echo ""
echo "════════════════════════════════════════════════════════════"

if [[ $FAILED -eq 0 ]]; then
    echo "✅ PRE-PUSH CHECKS PASSED"
    echo "════════════════════════════════════════════════════════════"
    exit 0
else
    echo "❌ PRE-PUSH CHECKS FAILED"
    echo "════════════════════════════════════════════════════════════"
    echo ""
    echo "Quick fixes:"
    echo "  1. Run: gofmt -w <files>"
    echo "  2. Run: goimports -w <files>"
    echo "  3. Fix build/lint errors in your code"
    echo "  4. Try push again"
    exit 1
fi
