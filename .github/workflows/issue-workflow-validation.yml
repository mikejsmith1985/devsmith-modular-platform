name: Validate Issue Workflow Standards

on:
  pull_request:
    types: [opened, edited, labeled, unlabeled]
    branches:
      - development
      - main

jobs:
  validate-issue-workflow:
    name: Validate Issue Workflow
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
      contents: read

    steps:
      - name: Check PR meets issue workflow standards
        id: check_workflow
        run: |
          PR_BODY="${{ github.event.pull_request.body }}"
          PR_LABELS="${{ toJson(github.event.pull_request.labels) }}"
          
          # Check for issue reference (Closes #XX)
          if echo "$PR_BODY" | grep -qE "Closes #[0-9]+"; then
            echo "✅ Found issue reference"
            has_issue_ref=true
          else
            echo "⚠️  No issue reference found"
            has_issue_ref=false
          fi
          
          # Check for required sections
          has_implementation=false
          has_tests=false
          has_quality=false
          has_checklist=false
          
          if echo "$PR_BODY" | grep -qi "## Implementation"; then
            has_implementation=true
          fi
          if echo "$PR_BODY" | grep -qi "## Tests"; then
            has_tests=true
          fi
          if echo "$PR_BODY" | grep -qi "## Quality"; then
            has_quality=true
          fi
          if echo "$PR_BODY" | grep -qi "- \[x\]"; then
            has_checklist=true
          fi
          
          echo "implementation=$has_implementation" >> $GITHUB_OUTPUT
          echo "tests=$has_tests" >> $GITHUB_OUTPUT
          echo "quality=$has_quality" >> $GITHUB_OUTPUT
          echo "checklist=$has_checklist" >> $GITHUB_OUTPUT
          echo "issue_ref=$has_issue_ref" >> $GITHUB_OUTPUT

      - name: Check enforce-workflows label
        id: check_enforce
        run: |
          PR_LABELS="${{ toJson(github.event.pull_request.labels.*.name) }}"
          if echo "$PR_LABELS" | grep -q "enforce-workflows"; then
            echo "strict_mode=true" >> $GITHUB_OUTPUT
          else
            echo "strict_mode=false" >> $GITHUB_OUTPUT
          fi

      - name: Enforce strict mode (when label present and target is development)
        if: |
          steps.check_enforce.outputs.strict_mode == 'true' &&
          github.base_ref == 'development'
        run: |
          ERRORS=0
          
          if [ "${{ steps.check_workflow.outputs.issue_ref }}" != "true" ]; then
            echo "❌ FAIL: PR body must contain 'Closes #XX'"
            ERRORS=$((ERRORS + 1))
          fi
          
          if [ "${{ steps.check_workflow.outputs.implementation }}" != "true" ]; then
            echo "❌ FAIL: PR must have '## Implementation' section"
            ERRORS=$((ERRORS + 1))
          fi
          
          if [ "${{ steps.check_workflow.outputs.tests }}" != "true" ]; then
            echo "❌ FAIL: PR must have '## Tests' section"
            ERRORS=$((ERRORS + 1))
          fi
          
          if [ "${{ steps.check_workflow.outputs.quality }}" != "true" ]; then
            echo "❌ FAIL: PR must have '## Quality' section"
            ERRORS=$((ERRORS + 1))
          fi
          
          if [ "${{ steps.check_workflow.outputs.checklist }}" != "true" ]; then
            echo "❌ FAIL: PR must have acceptance criteria checklist with completed items"
            ERRORS=$((ERRORS + 1))
          fi
          
          if [ $ERRORS -gt 0 ]; then
            echo ""
            echo "Strict mode enforcement: $ERRORS requirement(s) not met"
            exit 1
          fi
          
          echo "✅ All strict mode requirements met"

      - name: Advisory mode (when label absent or target is not development)
        if: |
          steps.check_enforce.outputs.strict_mode == 'false' ||
          github.base_ref != 'development'
        run: |
          echo "ℹ️  Running in advisory mode"
          
          if [ "${{ steps.check_workflow.outputs.issue_ref }}" != "true" ]; then
            echo "⚠️  Advisory: PR should contain 'Closes #XX'"
          fi
          
          if [ "${{ steps.check_workflow.outputs.implementation }}" != "true" ]; then
            echo "⚠️  Advisory: PR should have '## Implementation' section"
          fi
          
          if [ "${{ steps.check_workflow.outputs.tests }}" != "true" ]; then
            echo "⚠️  Advisory: PR should have '## Tests' section"
          fi
          
          if [ "${{ steps.check_workflow.outputs.quality }}" != "true" ]; then
            echo "⚠️  Advisory: PR should have '## Quality' section"
          fi
          
          if [ "${{ steps.check_workflow.outputs.checklist }}" != "true" ]; then
            echo "⚠️  Advisory: PR should have acceptance criteria checklist"
          fi
          
          echo "✅ Advisory mode completed (non-blocking)"
